<!DOCTYPE html>
  <html lang="sr">
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0">
    <title>Upravljanje igraƒçima</title>
    <script type="module" src="firebase.mjs"></script>

    <style>
      * {
        box-sizing: border-box;
      }

      body {
        font-family: Arial, sans-serif;
        max-width: 900px;
        margin: 20px auto;
        padding: 0 20px;
      }

      h1 { text-align:center; margin-bottom:25px; font-size: 28px; }

      #adminNav {
        display:flex; gap:10px; background:#f0f0f0;
        padding:12px; margin-bottom:25px;
        border-radius:8px; justify-content:center; border:1px solid #ddd;
        flex-wrap: wrap;
      }

      #adminNav button {
        padding:8px 12px; border-radius:6px; border:none;
        background:#0044cc; color:white; cursor:pointer; font-size:16px;
        min-height: 48px;
        min-width: 120px;
      }

      .team-title {
        font-size:22px; font-weight:bold;
        margin:25px 0 10px;
      }

      .input-row {
        display:flex; gap:10px; margin-bottom:15px;
      }

      input {
        flex:1; padding:10px; border-radius:6px;
        border:1px solid #aaa; font-size:16px;
        min-height: 48px;
      }

      .add-btn {
        background:green; color:white; padding:10px 16px;
        border-radius:6px; border:none; cursor:pointer;
        font-size: 16px;
        min-height: 48px;
        white-space: nowrap;
      }

      .table-wrapper {
        overflow-x: auto;
        -webkit-overflow-scrolling: touch;
        margin-bottom: 40px;
      }

      table {
        width:100%; border-collapse:collapse;
        text-align:center;
        min-width: 500px;
      }

      th {
        background:#ececec; padding:10px;
        border-bottom:2px solid #bbb;
        cursor:pointer;
        user-select:none;
        position:relative;
        font-size: 16px;
      }

      th:hover {
        background:#ddd;
      }

      th.sorted-asc::after {
        content: " ‚ñ≤";
        font-size: 12px;
        color: #0044cc;
      }

      th.sorted-desc::after {
        content: " ‚ñº";
        font-size: 12px;
        color: #0044cc;
      }

      td {
        padding:12px 10px;
        border-bottom:1px solid #ddd;
        font-size: 16px;
      }

      .edit-btn {
        background:#0044cc; color:white; border:none;
        padding:8px 12px; border-radius:4px; cursor:pointer;
        margin-right:5px;
        font-size: 16px;
        min-height: 44px;
      }

      .del-btn {
        background:#c00000; color:white; border:none;
        padding:8px 12px; border-radius:4px; cursor:pointer;
        font-size: 16px;
        min-height: 44px;
      }

      #resetStatsBtn {
        background:#b10000;
        color:white;
        padding:10px 20px;
        border:none;
        border-radius:6px;
        cursor:pointer;
        font-size:16px;
        margin-bottom:25px;
        min-height: 48px;
        width: 100%;
        max-width: 400px;
        display: block;
        margin-left: auto;
        margin-right: auto;
      }

      /* Captain and Goalkeeper badges */
      .captain-badge {
        display: inline-block;
        background: linear-gradient(135deg, #ffd700, #ffed4e);
        color: #333;
        font-weight: bold;
        padding: 2px 6px;
        border-radius: 4px;
        margin-left: 6px;
        font-size: 11px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        border: 1px solid #daa520;
      }

      .goalkeeper-badge {
        margin-left: 6px;
        font-size: 18px;
      }

      /* MODAL */
      #modalOverlay {
        display:none; position:fixed; inset:0;
        background:rgba(0,0,0,0.55);
        justify-content:center; align-items:center;
        backdrop-filter:blur(2px); z-index:999;
        padding: 20px;
      }

      #modalBox {
        background:white; padding:25px; border-radius:10px;
        width:90%; max-width:420px;
        box-shadow:0 0 25px rgba(0,0,0,0.25);
        animation: fadeIn 0.2s ease-out;
        max-height: 90vh;
        overflow-y: auto;
      }

      @keyframes fadeIn {
        from { opacity:0; transform:scale(0.9); }
        to   { opacity:1; transform:scale(1); }
      }

      #renameInput {
        width: 100%;
        padding: 12px;
        font-size: 16px;
        margin: 15px 0;
        border-radius: 6px;
        border: 1px solid #aaa;
        min-height: 48px;
      }

      .modal-buttons {
        display: flex;
        gap: 10px;
        margin-top: 20px;
        justify-content: flex-end;
      }

      .modal-buttons button {
        padding: 12px 20px;
        border: none;
        border-radius: 6px;
        cursor: pointer;
        font-size: 16px;
        min-height: 48px;
        flex: 1;
      }

      #renameCancel {
        background: #777;
        color: white;
      }

      #renameConfirm {
        background: #0044cc;
        color: white;
      }

      /* MOBILE RESPONSIVE */
      @media (max-width: 768px) {
        body {
          margin: 10px auto;
          padding: 0 15px;
        }

        h1 {
          font-size: 24px;
          margin-bottom: 20px;
        }

        #adminNav {
          gap: 8px;
          padding: 10px;
        }

        #adminNav button {
          flex: 1;
          min-width: 100px;
          font-size: 16px;
        }

        .team-title {
          font-size: 20px;
          margin: 20px 0 10px;
        }

        .input-row {
          gap: 8px;
        }

        .add-btn {
          padding: 10px 14px;
        }

        #resetStatsBtn {
          font-size: 16px;
          padding: 12px 16px;
          margin-bottom: 20px;
        }

        .table-wrapper {
          margin-bottom: 30px;
          border: 1px solid #ddd;
          border-radius: 8px;
        }

        table {
          font-size: 16px;
        }

        th, td {
          padding: 10px 8px;
          font-size: 16px;
        }

        .edit-btn, .del-btn {
          padding: 8px 10px;
          font-size: 14px;
          margin: 2px;
          display: inline-block;
        }

        #modalBox {
          padding: 20px;
          width: 95%;
        }

        #modalBox h3 {
          font-size: 20px;
        }

        .modal-buttons {
          flex-direction: column;
        }

        .modal-buttons button {
          width: 100%;
        }
      }

      @media (max-width: 480px) {
        body {
          padding: 0 10px;
        }

        h1 {
          font-size: 22px;
        }

        #adminNav {
          flex-direction: column;
          gap: 8px;
        }

        #adminNav button {
          width: 100%;
          min-width: unset;
        }

        .team-title {
          font-size: 18px;
        }

        .input-row {
          flex-direction: column;
          gap: 10px;
        }

        .add-btn {
          width: 100%;
        }

        td {
          padding: 8px 5px;
          font-size: 14px;
        }

        th {
          padding: 8px 5px;
          font-size: 14px;
        }

        .edit-btn, .del-btn {
          display: block;
          width: 100%;
          margin: 4px 0;
          padding: 10px;
        }

        /* Stack action buttons vertically in table cells */
        td:last-child {
          display: flex;
          flex-direction: column;
          gap: 4px;
          padding: 8px;
        }
      }
    </style>
  </head>

  <body>

  <!-- NAV -->
  <div id="adminNav">
    <button onclick="window.location.href='admin.html'">Meƒçevi</button>
    <button onclick="window.location.href='admin-igraci.html'">Igraƒçi</button>
    <button onclick="logout()">Logout</button>
  </div>

  <script>
    if (localStorage.getItem("admin") !== "1") window.location.href="login.html";
    function logout(){ localStorage.removeItem("admin"); window.location.href="index.html"; }
  </script>

  <h1>Upravljanje igraƒçima</h1>

  <!-- RESET SVIH STATISTIKA -->
  <button id="resetStatsBtn">
    Resetuj SVE golove i utakmice
  </button>

  <!-- CRVENI -->
  <div class="team-title" style="color:#b10000;">Crveni</div>
  <div class="input-row">
    <input id="redInput" placeholder="Ime igraƒça">
    <button class="add-btn" onclick="addPlayer('crveni')">Dodaj</button>
  </div>
  <div class="table-wrapper">
    <table>
      <thead>
      <tr>
        <th data-sort="name" data-team="crveni">Igraƒç</th>
        <th data-sort="goals" data-team="crveni">Golovi</th>
        <th data-sort="matches" data-team="crveni">Utakmice</th>
        <th>Akcija</th>
      </tr>
      </thead>
      <tbody id="redList"></tbody>
    </table>
  </div>

  <!-- PLAVI -->
  <div class="team-title" style="color:#0033aa;">Plavi</div>
  <div class="input-row">
    <input id="blueInput" placeholder="Ime igraƒça">
    <button class="add-btn" onclick="addPlayer('plavi')">Dodaj</button>
  </div>
  <div class="table-wrapper">
    <table>
      <thead>
      <tr>
        <th data-sort="name" data-team="plavi">Igraƒç</th>
        <th data-sort="goals" data-team="plavi">Golovi</th>
        <th data-sort="matches" data-team="plavi">Utakmice</th>
        <th>Akcija</th>
      </tr>
      </thead>
      <tbody id="blueList"></tbody>
    </table>
  </div>

  <!-- MODAL RENAME -->
  <div id="modalOverlay">
    <div id="modalBox">
      <h3 style="margin-top:0;">Izmena imena igraƒça</h3>

      <input id="renameInput" placeholder="Novo ime...">

      <div class="modal-buttons">
        <button id="renameCancel">Otka≈æi</button>
        <button id="renameConfirm">Saƒçuvaj</button>
      </div>
    </div>
  </div>

  <script type="module">
  import { onValue, push, set, update, remove, get }
    from "https://www.gstatic.com/firebasejs/10.8.1/firebase-database.js";

  /* ------------------ STATE ------------------ */
  const playersData = {
    crveni: {},
    plavi: {}
  };

  const sortState = {
    crveni: { field: 'name', dir: 'asc' },
    plavi: { field: 'name', dir: 'asc' }
  };

  /* ------------------ FORMAT PLAYER NAME ------------------ */
  function formatPlayerName(name) {
    if (!name) return '';

    let displayName = name;
    let badges = '';

    // Check for captain
    const captainRegex = /\s*\(c\)\s*/i;
    if (captainRegex.test(name)) {
      displayName = name.replace(captainRegex, ' ').trim();
      badges += '<span class="captain-badge">C</span>';
    }

    // Check for goalkeeper
    const goalkeeperRegex = /\s*\(g\)\s*/i;
    if (goalkeeperRegex.test(name)) {
      displayName = name.replace(goalkeeperRegex, ' ').trim();
      badges += '<span class="goalkeeper-badge">üß§</span>';
    }

    return displayName + badges;
  }

  /* ------------------ TEMPLATE ------------------ */
  function rowTemplate(id, player, team) {
    return `
      <tr>
        <td>${formatPlayerName(player.name)}</td>
        <td>${player.goals || 0}</td>
        <td>${player.matches || 0}</td>
        <td>
          <button class="edit-btn" onclick="openRename('${team}','${id}','${player.name}')">Izmeni</button>
          <button class="del-btn" onclick="deletePlayer('${team}','${id}','${player.name}')">Obri≈°i</button>
        </td>
      </tr>
    `;
  }

  /* ------------------ RENDER WITH SORTING ------------------ */
  function renderPlayers(team, elementId) {
    const tbody = document.getElementById(elementId);
    const data = playersData[team];

    // Convert to array
    let players = Object.entries(data).map(([id, p]) => ({
      id,
      name: p.name || "",
      goals: Number(p.goals) || 0,
      matches: Number(p.matches) || 0
    }));

    // Sort
    const { field, dir } = sortState[team];
    players.sort((a, b) => {
      if (field === 'name') {
        // Remove badges for sorting
        const nameA = a.name.replace(/\s*\(c\)\s*/gi, '').replace(/\s*\(g\)\s*/gi, '').trim().toLowerCase();
        const nameB = b.name.replace(/\s*\(c\)\s*/gi, '').replace(/\s*\(g\)\s*/gi, '').trim().toLowerCase();
        return dir === 'asc'
          ? nameA.localeCompare(nameB, 'sr')
          : nameB.localeCompare(nameA, 'sr');
      } else {
        if (a[field] === b[field]) {
          const nameA = a.name.replace(/\s*\(c\)\s*/gi, '').replace(/\s*\(g\)\s*/gi, '').trim();
          const nameB = b.name.replace(/\s*\(c\)\s*/gi, '').replace(/\s*\(g\)\s*/gi, '').trim();
          return nameA.localeCompare(nameB, 'sr');
        }
        return dir === 'asc' ? a[field] - b[field] : b[field] - a[field];
      }
    });

    // Render
    tbody.innerHTML = "";
    players.forEach(p => {
      tbody.innerHTML += rowTemplate(p.id, p, team);
    });

    // Update sort indicators
    updateSortIndicators(team);
  }

  /* ------------------ UPDATE SORT INDICATORS ------------------ */
  function updateSortIndicators(team) {
    const { field, dir } = sortState[team];

    document.querySelectorAll(`th[data-team="${team}"]`).forEach(th => {
      th.classList.remove('sorted-asc', 'sorted-desc');
      if (th.dataset.sort === field) {
        th.classList.add(dir === 'asc' ? 'sorted-asc' : 'sorted-desc');
      }
    });
  }

  /* ------------------ LOAD ------------------ */
  function loadPlayers(team, elementId) {
    onValue(window.dbRef("players/" + team), snap => {
      playersData[team] = snap.val() || {};
      renderPlayers(team, elementId);
    });
  }

  loadPlayers("crveni","redList");
  loadPlayers("plavi","blueList");

  /* ------------------ SORTING EVENT LISTENERS ------------------ */
  document.addEventListener('DOMContentLoaded', () => {
    document.querySelectorAll('th[data-sort]').forEach(th => {
      th.addEventListener('click', () => {
        const field = th.dataset.sort;
        const team = th.dataset.team;

        // Toggle direction if same field, otherwise reset to desc
        if (sortState[team].field === field) {
          sortState[team].dir = sortState[team].dir === 'asc' ? 'desc' : 'asc';
        } else {
          sortState[team].field = field;
          sortState[team].dir = field === 'name' ? 'asc' : 'desc';
        }

        renderPlayers(team, team === 'crveni' ? 'redList' : 'blueList');
      });
    });
  });

  /* ------------------ ADD ------------------ */
  window.addPlayer = team => {
    const input = document.getElementById(team === "crveni" ? "redInput" : "blueInput");
    const name = input.value.trim();
    if (!name) return;

    push(window.dbRef("players/" + team), {
      name, goals: 0, matches: 0
    });

    input.value = "";
  };

  /* ------------------ DELETE ‚Äî HARD DELETE ------------------ */
  window.deletePlayer = async (team, id, name) => {
    const cleanName = name.replace(/\s*\(c\)\s*/gi, '').replace(/\s*\(g\)\s*/gi, '').trim();
    if (!confirm(`Obrisati igraƒça ${cleanName} i ukloniti ga iz SVIH meƒçeva?`)) return;

    const matchesSnap = await get(window.dbRef("matches"));
    const matches = matchesSnap.val() || {};

    for (const matchId of Object.keys(matches)) {
      const m = matches[matchId];

      // ukloni iz played (po ID-u)
      if (m.played && m.played[id]) {
        delete m.played[id];
      }

      // ukloni iz scorers (po ID-u)
      if (m.scorers) {
        m.scorers = m.scorers.filter(s => s.id !== id);
      }

      await update(window.dbRef("matches/" + matchId), {
        played: m.played || {},
        scorers: m.scorers || []
      });
    }

    await remove(window.dbRef(`players/${team}/${id}`));
  };

  /* ------------------ RENAME ------------------ */
  let renameTeam = null;
  let renameId   = null;

  window.openRename = (team, id, oldName) => {
    renameTeam = team;
    renameId = id;
    document.getElementById("renameInput").value = oldName;
    document.getElementById("modalOverlay").style.display = "flex";
  };

  document.getElementById("renameConfirm").onclick = async () => {
    const newName = document.getElementById("renameInput").value.trim();
    if (!newName) return;

    await update(window.dbRef(`players/${renameTeam}/${renameId}`), { name: newName });
    document.getElementById("modalOverlay").style.display = "none";
  };

  document.getElementById("renameCancel").onclick = () => {
    document.getElementById("modalOverlay").style.display = "none";
  };

  /* ------------------ RESET STATISTICS ------------------ */
  document.getElementById("resetStatsBtn").onclick = async () => {
    if (!confirm("Da li sigurno ≈æeli≈° da resetuje≈° SVE golove i utakmice?")) return;

    const snap = await get(window.dbRef("players"));
    const data = snap.val() || {};

    for (const team of ["crveni","plavi"]) {
      if (!data[team]) continue;
      for (const id of Object.keys(data[team])) {
        await update(window.dbRef(`players/${team}/${id}`), {
          goals: 0,
          matches: 0
        });
      }
    }

    alert("Statistika resetovana!");
  };
  </script>

  <script>
  // klik na pozadinu = zatvori modal
  document.getElementById("modalOverlay").onclick = e => {
    if (e.target.id === "modalOverlay")
      e.target.style.display = "none";
  };
  </script>

  </body>
  </html>
