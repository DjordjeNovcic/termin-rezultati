<!DOCTYPE html>
<html lang="sr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0">
  <title>Upravljanje igraƒçima</title>
  <link rel="stylesheet" href="styles.css">
  <script type="module" src="firebase.mjs"></script>

  <style>
    /* Page-specific styles only */
    .container {
      max-width: 900px;
    }

    /* HEADER */
    header {
      background: white;
      border-radius: 16px;
      padding: 20px 30px;
      margin-bottom: 20px;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-wrap: wrap;
      gap: 15px;
    }

    .logo {
      font-size: 24px;
      font-weight: bold;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }

    .nav-buttons {
      display: flex;
      gap: 10px;
    }

    .nav-btn-header {
      padding: 10px 20px;
      border: none;
      border-radius: 10px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      background: #f0f0f0;
      color: #333;
    }

    .nav-btn-header:hover {
      background: #e0e0e0;
      transform: translateY(-2px);
    }

    .nav-btn-header.active {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
    }

    .nav-btn-header.logout {
      background: #ff4757;
      color: white;
    }

    .nav-btn-header.logout:hover {
      background: #ee5a6f;
    }

    .team-title {
      font-size: 22px;
      font-weight: bold;
      margin: 25px 0 15px;
    }

    .input-row {
      display: flex;
      gap: 10px;
      margin-bottom: 20px;
    }

    .add-btn {
      background: linear-gradient(135deg, #00b894 0%, #00cec9 100%);
      color: white;
      padding: 10px 20px;
      border-radius: 10px;
      border: none;
      cursor: pointer;
      font-size: 16px;
      min-height: 48px;
      white-space: nowrap;
      font-weight: 600;
      transition: all 0.3s ease;
      box-shadow: 0 4px 15px rgba(0, 184, 148, 0.3);
    }

    .add-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(0, 184, 148, 0.4);
    }

    #resetStatsBtn {
      background: linear-gradient(135deg, #ff4757 0%, #ee5a6f 100%);
      color: white;
      padding: 14px 24px;
      border: none;
      border-radius: 12px;
      cursor: pointer;
      font-size: 16px;
      margin-bottom: 25px;
      min-height: 48px;
      width: 100%;
      max-width: 400px;
      display: block;
      margin-left: auto;
      margin-right: auto;
      font-weight: 600;
      transition: all 0.3s ease;
      box-shadow: 0 4px 15px rgba(255, 71, 87, 0.3);
    }

    #resetStatsBtn:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(255, 71, 87, 0.4);
    }

    /* Modal specific positioning */
    #modalOverlay {
      display: none;
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.7);
      justify-content: center;
      align-items: center;
      backdrop-filter: blur(4px);
      z-index: 999;
      padding: 20px;
    }

    #modalBox {
      background: white;
      padding: 30px;
      border-radius: 16px;
      width: 90%;
      max-width: 420px;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
      animation: slideUp 0.3s ease;
      max-height: 90vh;
      overflow-y: auto;
    }

    @keyframes slideUp {
      from {
        transform: translateY(50px);
        opacity: 0;
      }
      to {
        transform: translateY(0);
        opacity: 1;
      }
    }

    #modalBox h3 {
      margin-top: 0;
      margin-bottom: 20px;
      color: #2d3436;
    }

    #renameInput {
      width: 100%;
      padding: 14px 16px;
      font-size: 16px;
      margin: 15px 0;
      border-radius: 10px;
      border: 2px solid #e0e0e0;
      min-height: 48px;
      transition: all 0.3s ease;
    }

    #renameInput:focus {
      outline: none;
      border-color: #667eea;
      box-shadow: 0 0 0 4px rgba(102, 126, 234, 0.1);
    }

    .modal-buttons {
      display: flex;
      gap: 10px;
      margin-top: 20px;
      justify-content: flex-end;
    }

    .modal-buttons button {
      padding: 12px 24px;
      border: none;
      border-radius: 10px;
      cursor: pointer;
      font-size: 16px;
      min-height: 48px;
      flex: 1;
      font-weight: 600;
      transition: all 0.3s ease;
    }

    #renameCancel {
      background: #636e72;
      color: white;
    }

    #renameCancel:hover {
      background: #4a5558;
      transform: translateY(-2px);
    }

    #renameConfirm {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
    }

    #renameConfirm:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
    }

    /* MOBILE RESPONSIVE */
    @media (max-width: 768px) {
      .container {
        max-width: 100%;
      }

      header {
        padding: 15px 20px;
        border-radius: 12px;
        flex-direction: column;
        align-items: stretch;
      }

      .logo {
        text-align: center;
        font-size: 20px;
      }

      .nav-buttons {
        flex-direction: column;
      }

      .nav-btn-header {
        width: 100%;
        text-align: center;
      }

      .team-title {
        font-size: 20px;
        margin: 20px 0 12px;
      }

      .input-row {
        gap: 8px;
      }

      #resetStatsBtn {
        font-size: 16px;
        padding: 12px 20px;
        margin-bottom: 20px;
      }

      #modalBox {
        padding: 20px;
        width: 95%;
      }

      #modalBox h3 {
        font-size: 20px;
      }

      .modal-buttons {
        flex-direction: column;
      }
    }

    @media (max-width: 480px) {
      .logo {
        font-size: 18px;
      }

      .nav-btn-header {
        padding: 12px 16px;
        font-size: 13px;
      }

      .team-title {
        font-size: 18px;
      }

      .input-row {
        flex-direction: column;
        gap: 10px;
      }

      .add-btn {
        width: 100%;
      }
    }
  </style>
</head>

<body>

<div class="container">
  <!-- HEADER -->
  <header>
    <div class="logo">‚öΩ Admin Panel</div>
    <div class="nav-buttons">
      <button class="nav-btn-header" onclick="window.location.href='admin.html'">Meƒçevi</button>
      <button class="nav-btn-header active" onclick="window.location.href='admin-igraci.html'">Igraƒçi</button>
      <button class="nav-btn-header logout" onclick="logout()">Logout</button>
    </div>
  </header>

  <script>
    if (localStorage.getItem("admin") !== "1") window.location.href="login.html";
    function logout(){ localStorage.removeItem("admin"); window.location.href="index.html"; }
  </script>

  <!-- MAIN CARD -->
  <div class="card">
    <h1 class="card-title">Upravljanje igraƒçima</h1>

    <!-- RESET SVIH STATISTIKA -->
    <button id="resetStatsBtn">
      Resetuj SVE golove i utakmice
    </button>

    <!-- CRVENI -->
    <div class="team-title" style="color:#d63031;">Crveni</div>
    <div class="input-row">
      <input id="redInput" placeholder="Ime igraƒça">
      <button class="add-btn" onclick="addPlayer('crveni')">Dodaj</button>
    </div>
    <div class="table-wrapper">
      <table>
        <thead>
        <tr>
          <th data-sort="name" data-team="crveni">Igraƒç</th>
          <th data-sort="goals" data-team="crveni">Golovi</th>
          <th data-sort="matches" data-team="crveni">Utakmice</th>
          <th>Akcija</th>
        </tr>
        </thead>
        <tbody id="redList"></tbody>
      </table>
    </div>

    <!-- PLAVI -->
    <div class="team-title" style="color:#0984e3;">Plavi</div>
    <div class="input-row">
      <input id="blueInput" placeholder="Ime igraƒça">
      <button class="add-btn" onclick="addPlayer('plavi')">Dodaj</button>
    </div>
    <div class="table-wrapper">
      <table>
        <thead>
        <tr>
          <th data-sort="name" data-team="plavi">Igraƒç</th>
          <th data-sort="goals" data-team="plavi">Golovi</th>
          <th data-sort="matches" data-team="plavi">Utakmice</th>
          <th>Akcija</th>
        </tr>
        </thead>
        <tbody id="blueList"></tbody>
      </table>
    </div>
  </div>
</div>

<!-- MODAL RENAME -->
<div id="modalOverlay">
  <div id="modalBox">
    <h3>Izmena imena igraƒça</h3>

    <input id="renameInput" placeholder="Novo ime...">

    <div class="modal-buttons">
      <button id="renameCancel">Otka≈æi</button>
      <button id="renameConfirm">Saƒçuvaj</button>
    </div>
  </div>
</div>

<script type="module">
import { onValue, push, set, update, remove, get }
  from "https://www.gstatic.com/firebasejs/10.8.1/firebase-database.js";

/* ------------------ STATE ------------------ */
const playersData = {
  crveni: {},
  plavi: {}
};

const sortState = {
  crveni: { field: 'name', dir: 'asc' },
  plavi: { field: 'name', dir: 'asc' }
};

/* ------------------ FORMAT PLAYER NAME ------------------ */
function formatPlayerName(name) {
  if (!name) return '';

  let displayName = name;
  let badges = '';

  // Check for captain
  const captainRegex = /\s*\(c\)\s*/i;
  if (captainRegex.test(name)) {
    displayName = name.replace(captainRegex, ' ').trim();
    badges += '<span class="captain-badge">C</span>';
  }

  // Check for goalkeeper
  const goalkeeperRegex = /\s*\(g\)\s*/i;
  if (goalkeeperRegex.test(name)) {
    displayName = name.replace(goalkeeperRegex, ' ').trim();
    badges += '<span class="goalkeeper-badge">üß§</span>';
  }

  return displayName + badges;
}

/* ------------------ TEMPLATE ------------------ */
function rowTemplate(id, player, team) {
  return `
    <tr>
      <td>${formatPlayerName(player.name)}</td>
      <td>${player.goals || 0}</td>
      <td>${player.matches || 0}</td>
      <td>
        <button class="edit-btn" onclick="openRename('${team}','${id}','${player.name}')">Izmeni</button>
        <button class="del-btn" onclick="deletePlayer('${team}','${id}','${player.name}')">Obri≈°i</button>
      </td>
    </tr>
  `;
}

/* ------------------ RENDER WITH SORTING ------------------ */
function renderPlayers(team, elementId) {
  const tbody = document.getElementById(elementId);
  const data = playersData[team];

  // Convert to array
  let players = Object.entries(data).map(([id, p]) => ({
    id,
    name: p.name || "",
    goals: Number(p.goals) || 0,
    matches: Number(p.matches) || 0
  }));

  // Sort
  const { field, dir } = sortState[team];
  players.sort((a, b) => {
    if (field === 'name') {
      // Remove badges for sorting
      const nameA = a.name.replace(/\s*\(c\)\s*/gi, '').replace(/\s*\(g\)\s*/gi, '').trim().toLowerCase();
      const nameB = b.name.replace(/\s*\(c\)\s*/gi, '').replace(/\s*\(g\)\s*/gi, '').trim().toLowerCase();
      return dir === 'asc'
        ? nameA.localeCompare(nameB, 'sr')
        : nameB.localeCompare(nameA, 'sr');
    } else {
      if (a[field] === b[field]) {
        const nameA = a.name.replace(/\s*\(c\)\s*/gi, '').replace(/\s*\(g\)\s*/gi, '').trim();
        const nameB = b.name.replace(/\s*\(c\)\s*/gi, '').replace(/\s*\(g\)\s*/gi, '').trim();
        return nameA.localeCompare(nameB, 'sr');
      }
      return dir === 'asc' ? a[field] - b[field] : b[field] - a[field];
    }
  });

  // Render
  tbody.innerHTML = "";
  players.forEach(p => {
    tbody.innerHTML += rowTemplate(p.id, p, team);
  });

  // Update sort indicators
  updateSortIndicators(team);
}

/* ------------------ UPDATE SORT INDICATORS ------------------ */
function updateSortIndicators(team) {
  const { field, dir } = sortState[team];

  document.querySelectorAll(`th[data-team="${team}"]`).forEach(th => {
    th.classList.remove('sorted-asc', 'sorted-desc');
    if (th.dataset.sort === field) {
      th.classList.add(dir === 'asc' ? 'sorted-asc' : 'sorted-desc');
    }
  });
}

/* ------------------ LOAD ------------------ */
function loadPlayers(team, elementId) {
  onValue(window.dbRef("players/" + team), snap => {
    playersData[team] = snap.val() || {};
    renderPlayers(team, elementId);
  });
}

loadPlayers("crveni","redList");
loadPlayers("plavi","blueList");

/* ------------------ SORTING EVENT LISTENERS ------------------ */
document.addEventListener('DOMContentLoaded', () => {
  document.querySelectorAll('th[data-sort]').forEach(th => {
    th.addEventListener('click', () => {
      const field = th.dataset.sort;
      const team = th.dataset.team;

      // Toggle direction if same field, otherwise reset to desc
      if (sortState[team].field === field) {
        sortState[team].dir = sortState[team].dir === 'asc' ? 'desc' : 'asc';
      } else {
        sortState[team].field = field;
        sortState[team].dir = field === 'name' ? 'asc' : 'desc';
      }

      renderPlayers(team, team === 'crveni' ? 'redList' : 'blueList');
    });
  });
});

/* ------------------ ADD ------------------ */
window.addPlayer = team => {
  const input = document.getElementById(team === "crveni" ? "redInput" : "blueInput");
  const name = input.value.trim();
  if (!name) return;

  push(window.dbRef("players/" + team), {
    name, goals: 0, matches: 0
  });

  input.value = "";
};

/* ------------------ DELETE ‚Äî HARD DELETE ------------------ */
window.deletePlayer = async (team, id, name) => {
  const cleanName = name.replace(/\s*\(c\)\s*/gi, '').replace(/\s*\(g\)\s*/gi, '').trim();
  if (!confirm(`Obrisati igraƒça ${cleanName} i ukloniti ga iz SVIH meƒçeva?`)) return;

  const matchesSnap = await get(window.dbRef("matches"));
  const matches = matchesSnap.val() || {};

  for (const matchId of Object.keys(matches)) {
    const m = matches[matchId];

    // ukloni iz played (po ID-u)
    if (m.played && m.played[id]) {
      delete m.played[id];
    }

    // ukloni iz scorers (po ID-u)
    if (m.scorers) {
      m.scorers = m.scorers.filter(s => s.id !== id);
    }

    await update(window.dbRef("matches/" + matchId), {
      played: m.played || {},
      scorers: m.scorers || []
    });
  }

  await remove(window.dbRef(`players/${team}/${id}`));
};

/* ------------------ RENAME ------------------ */
let renameTeam = null;
let renameId   = null;

window.openRename = (team, id, oldName) => {
  renameTeam = team;
  renameId = id;
  document.getElementById("renameInput").value = oldName;
  document.getElementById("modalOverlay").style.display = "flex";
};

document.getElementById("renameConfirm").onclick = async () => {
  const newName = document.getElementById("renameInput").value.trim();
  if (!newName) return;

  await update(window.dbRef(`players/${renameTeam}/${renameId}`), { name: newName });
  document.getElementById("modalOverlay").style.display = "none";
};

document.getElementById("renameCancel").onclick = () => {
  document.getElementById("modalOverlay").style.display = "none";
};

/* ------------------ RESET STATISTICS ------------------ */
document.getElementById("resetStatsBtn").onclick = async () => {
  if (!confirm("Da li sigurno ≈æeli≈° da resetuje≈° SVE golove i utakmice?")) return;

  const snap = await get(window.dbRef("players"));
  const data = snap.val() || {};

  for (const team of ["crveni","plavi"]) {
    if (!data[team]) continue;
    for (const id of Object.keys(data[team])) {
      await update(window.dbRef(`players/${team}/${id}`), {
        goals: 0,
        matches: 0
      });
    }
  }

  alert("Statistika resetovana!");
};
</script>

<script>
// klik na pozadinu = zatvori modal
document.getElementById("modalOverlay").onclick = e => {
  if (e.target.id === "modalOverlay")
    e.target.style.display = "none";
};
</script>

</body>
</html>
