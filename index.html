 <!DOCTYPE html>
  <html lang="sr">
  <head>
    <meta charset="UTF-8">
    <title>Rezultati</title>
    <script type="module" src="firebase.mjs"></script>

    <style>
      body {
        font-family: Arial, sans-serif;
        max-width: 900px;
        margin: 20px auto;
        padding: 0 15px;
        text-align: center;
      }

      h1 { margin-bottom: 25px; }

      #loginHolder {
        width: 100%;
        display: flex;
        justify-content: center;
        margin-bottom: 20px;
      }

      #loginBtn {
        padding: 8px 16px;
        background: #0044cc;
        color: white;
        border-radius: 6px;
        cursor: pointer;
        border: none;
        font-size: 15px;
      }

      /* KARTICA MEČA */
      .match-box {
        padding: 25px;
        border-radius: 12px;
        background: #fff6f6;
        border: 1px solid #e5dcdc;
        margin-bottom: 25px;
      }

      .team-logo { width: 90px; height: 90px; }
      .team-name { font-weight: bold; margin-top: 5px; }

      .score {
        font-size: 38px;
        font-weight: bold;
        margin: 10px 0;
      }

      .score-small {
        font-size: 26px;
        font-weight: bold;
        margin: 5px 0;
      }

      .info-link {
        color: #0044cc;
        cursor: pointer;
        font-size: 15px;
        text-decoration: underline;
      }

      /* TABELA */
      table {
        margin: 25px auto;
        width: 100%;
        border-collapse: collapse;
      }
      th {
        background: #ececec;
        padding: 10px;
        border-bottom: 2px solid #bbb;
        cursor: pointer;
        user-select: none;
        position: relative;
      }
      th:hover {
        background: #ddd;
      }
      th.sorted-asc::after {
        content: " ▲";
        font-size: 12px;
        color: #0044cc;
      }
      th.sorted-desc::after {
        content: " ▼";
        font-size: 12px;
        color: #0044cc;
      }
      th.no-sort {
        cursor: default;
      }
      th.no-sort:hover {
        background: #ececec;
      }
      td {
        padding: 10px;
        border-bottom: 1px solid #ddd;
      }
      tr.highlight { background: #fff7d1; }

      /* SCORER COLORS */
      tr.team-crveni {
        background: #ffe5e5;
      }
      tr.team-plavi {
        background: #e5f0ff;
      }
      tr.team-crveni td:first-child {
        color: #b10000;
        font-weight: bold;
      }
      tr.team-plavi td:first-child {
        color: #0044cc;
        font-weight: bold;
      }

      /* FORMA */
      .form-box { margin-top: 30px; }

      .dot {
        width: 14px;
        height: 14px;
        border-radius: 50%;
        display: inline-block;
        margin-left: 5px;
      }
      .win { background: green; }
      .loss { background: red; }
      .draw { background: orange; }

      /* Dugme */
      .more-btn {
        padding: 10px 20px;
        margin-top: 15px;
        cursor: pointer;
        border: none;
        background: #0044cc;
        color: white;
        border-radius: 6px;
        font-size: 15px;
      }

      /* MODAL */
      #modalOverlay {
        display: none;
        position: fixed;
        top: 0; left: 0;
        width: 100%; height: 100%;
        background: rgba(0,0,0,0.55);
        backdrop-filter: blur(2px);
        justify-content: center;
        align-items: center;
      }
      #modalBox {
        background: white;
        max-width: 600px;
        width: 90%;
        padding: 25px;
        border-radius: 12px;
        text-align: left;
        box-shadow: 0 0 20px rgba(0,0,0,0.25);
      }
      #closeModal {
        float: right;
        cursor: pointer;
        font-size: 18px;
        background: #ccc;
        border-radius: 4px;
        padding: 4px 8px;
      }
    </style>
  </head>
  <body>

  <div id="loginHolder">
    <button id="loginBtn" onclick="window.location='login.html'">Login</button>
  </div>

  <h1>Rezultat poslednjeg kola</h1>

  <!-- GLAVNI MEČ -->
  <div id="mainMatch"></div>

  <!-- TABELA -->
  <h2>Tabela</h2>
  <table>
    <thead>
      <tr>
        <th class="no-sort">Tim</th>
        <th data-sort="U" data-table="league">Utakmice</th>
        <th data-sort="P" data-table="league">Pobede</th>
        <th data-sort="N" data-table="league">Nerešeno</th>
        <th data-sort="I" data-table="league">Porazi</th>
        <th data-sort="GD" data-table="league">G. dati</th>
        <th data-sort="GP" data-table="league">G. primljeni</th>
        <th data-sort="GR" data-table="league">G. razlika</th>
        <th data-sort="B" data-table="league">Bodovi</th>
      </tr>
    </thead>
    <tbody id="leagueBody"></tbody>
  </table>

  <!-- LISTA STRELACA -->
  <h2>Lista strelaca</h2>
  <table>
    <thead>
      <tr>
        <th data-sort="name" data-table="scorers">Ime</th>
        <th data-sort="team" data-table="scorers">Tim</th>
        <th data-sort="goals" data-table="scorers">Golovi</th>
      </tr>
    </thead>
    <tbody id="scorersBody"></tbody>
  </table>

  <!-- FORMA -->
  <div class="form-box">
    <h2>Forma poslednjih 5 mečeva</h2>
    <div id="formBox"></div>
  </div>

  <!-- MINI REZULTATI DOLE -->
  <div id="recentMatches"></div>

  <!-- MODAL -->
  <div id="modalOverlay">
    <div id="modalBox">
      <span id="closeModal">✕</span>
      <h2>Info o meču</h2>
      <div id="modalContent" style="white-space:pre-line; margin-top:10px;"></div>
    </div>
  </div>

  <script type="module">
  import { onValue } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-database.js";

  let allMatches = [];
  let tableData = {};
  let scorersData = [];
  let currentSort = {
    league: { field: 'B', dir: 'desc' },
    scorers: { field: 'goals', dir: 'desc' }
  };

  /* LOAD MATCHES */
  onValue(window.dbRef("matches"), snap => {
    const data = snap.val() || {};
    allMatches = Object.values(data).sort((a,b)=>b.timestamp - a.timestamp);

    renderMainAndRecent(allMatches);
    calculateTable(allMatches);
    renderTable();
    renderForm(allMatches);
  });

  /* LOAD PLAYERS FOR SCORERS */
  onValue(window.dbRef("players"), snap => {
    const players = snap.val() || {};
    scorersData = [];

    ['crveni', 'plavi'].forEach(team => {
      if (players[team]) {
        Object.entries(players[team]).forEach(([id, player]) => {
          const goals = Number(player.goals) || 0;
          if (goals >= 1) {
            scorersData.push({
              name: player.name || '',
              team: team === 'crveni' ? 'Crveni' : 'Plavi',
              teamKey: team,
              goals: goals
            });
          }
        });
      }
    });

    renderScorers();
  });

  /* -------- MAIN MATCH + RECENT (DOLE) -------- */
  function renderMainAndRecent(matches) {
    const mainBox = document.getElementById("mainMatch");
    const recentBox = document.getElementById("recentMatches");

    mainBox.innerHTML = "";
    recentBox.innerHTML = "";

    if (!matches.length) return;

    const latest = matches[0];

    /* ---- Najnoviji meč ---- */
    mainBox.innerHTML = `
      <div class="match-box">
        <div style="opacity:0.8; margin-bottom:10px;">
          Kolo ${latest.round} — ${latest.date} u ${latest.time}
          ${latest.info ? `<div class="info-link" onclick="openInfo(\`${latest.info.replace(/`/g,"\\`")}\`)">ℹ Info o meču</div>` : ""}
        </div>

        <div style="display:flex; justify-content:space-around; align-items:center;">
          
          <div style="text-align:center;">
            <img src="crveni.png" class="team-logo">
            <div class="team-name" style="color:#c00000;">Crveni</div>
            <a href="crveni.html" style="font-size:14px;">Vidi ekipu</a>
          </div>

          <div class="score">${latest.red} - ${latest.blue}</div>

          <div style="text-align:center;">
            <img src="plavi.png" class="team-logo">
            <div class="team-name" style="color:#0044cc;">Plavi</div>
            <a href="plavi.html" style="font-size:14px;">Vidi ekipu</a>
          </div>

        </div>
      </div>
    `;

    /* ---- Poslednja 3 meča DOLE ---- */
    const recent = matches.slice(1,4);

    if (recent.length) {
      recentBox.innerHTML += `<h1 style="margin-bottom:15px; margin-top:30px;">Rezultati prošlih kola</h1>`;

      recent.forEach(m => {
        recentBox.innerHTML += `
          <div class="match-box" style="background:#fcfcfc; border-color:#ddd; padding:18px;">
            <div style="opacity:0.7; margin-bottom:8px;">
              Kolo ${m.round} — ${m.date} u ${m.time}
              ${m.info ? `<div class="info-link" onclick="openInfo(\`${m.info.replace(/`/g,"\\`")}\`)">ℹ Info o meču</div>` : ""}
            </div>

            <div style="display:flex; justify-content:space-around; align-items:center;">

              <div style="text-align:center;">
                <img src="crveni.png" class="team-logo" style="width:60px; height:60px;">
                <div class="team-name" style="font-size:14px; color:#c00000;">Crveni</div>
              </div>

              <div class="score-small">${m.red} - ${m.blue}</div>

              <div style="text-align:center;">
                <img src="plavi.png" class="team-logo" style="width:60px; height:60px;">
                <div class="team-name" style="font-size:14px; color:#0044cc;">Plavi</div>
              </div>

            </div>
          </div>
        `;
      });

      recentBox.innerHTML += `
        <button class="more-btn" onclick="window.location='istorija.html'">
          Vidi sve utakmice →
        </button>
      `;
    }
  }

  /* -------- CALCULATE TABLE DATA -------- */
  function calculateTable(matches) {
    tableData = {
      Crveni: { Tim: 'Crveni', U:0,P:0,N:0,I:0,GD:0,GP:0,GR:0,B:0 },
      Plavi:  { Tim: 'Plavi', U:0,P:0,N:0,I:0,GD:0,GP:0,GR:0,B:0 }
    };

    matches.forEach(m=>{
      tableData.Crveni.U++; tableData.Plavi.U++;

      tableData.Crveni.GD += m.red;
      tableData.Crveni.GP += m.blue;

      tableData.Plavi.GD += m.blue;
      tableData.Plavi.GP += m.red;

      if (m.red > m.blue) {
        tableData.Crveni.P++; tableData.Crveni.B += 3; tableData.Plavi.I++;
      } else if (m.blue > m.red) {
        tableData.Plavi.P++; tableData.Plavi.B += 3; tableData.Crveni.I++;
      } else {
        tableData.Crveni.N++; tableData.Plavi.N++;
        tableData.Crveni.B++; tableData.Plavi.B++;
      }
    });

    tableData.Crveni.GR = tableData.Crveni.GD - tableData.Crveni.GP;
    tableData.Plavi.GR  = tableData.Plavi.GD - tableData.Plavi.GP;
  }

  /* -------- RENDER TABLE WITH SORTING -------- */
  function renderTable() {
    const teams = Object.values(tableData);
    const { field, dir } = currentSort.league;

    // Sort teams
    teams.sort((a, b) => {
      const valA = a[field];
      const valB = b[field];

      if (valA === valB) {
        return b.B - a.B; // Secondary sort by points
      }

      return dir === 'asc' ? valA - valB : valB - valA;
    });

    const tbody = document.getElementById("leagueBody");
    tbody.innerHTML = "";

    teams.forEach((team, index) => {
      const highlightClass = index === 0 ? 'class="highlight"' : '';
      tbody.innerHTML += `
        <tr ${highlightClass}>
          <td>${team.Tim}</td>
          <td>${team.U}</td>
          <td>${team.P}</td>
          <td>${team.N}</td>
          <td>${team.I}</td>
          <td>${team.GD}</td>
          <td>${team.GP}</td>
          <td>${team.GR}</td>
          <td>${team.B}</td>
        </tr>
      `;
    });

    updateSortIndicators('league');
  }

  /* -------- RENDER SCORERS TABLE -------- */
  function renderScorers() {
    const scorers = [...scorersData];
    const { field, dir } = currentSort.scorers;

    // Sort scorers
    scorers.sort((a, b) => {
      if (field === 'name') {
        const nameA = a.name.toLowerCase();
        const nameB = b.name.toLowerCase();
        return dir === 'asc'
          ? nameA.localeCompare(nameB, 'sr')
          : nameB.localeCompare(nameA, 'sr');
      } else if (field === 'team') {
        if (a.team === b.team) {
          return b.goals - a.goals; // Secondary sort by goals
        }
        return dir === 'asc'
          ? a.team.localeCompare(b.team, 'sr')
          : b.team.localeCompare(a.team, 'sr');
      } else { // goals
        if (a.goals === b.goals) {
          return a.name.localeCompare(b.name, 'sr');
        }
        return dir === 'asc' ? a.goals - b.goals : b.goals - a.goals;
      }
    });

    const tbody = document.getElementById("scorersBody");
    tbody.innerHTML = "";

    scorers.forEach(player => {
      tbody.innerHTML += `
        <tr class="team-${player.teamKey}">
          <td>${player.name}</td>
          <td>${player.team}</td>
          <td>${player.goals}</td>
        </tr>
      `;
    });

    updateSortIndicators('scorers');
  }

  /* -------- UPDATE SORT INDICATORS -------- */
  function updateSortIndicators(table) {
    const { field, dir } = currentSort[table];

    document.querySelectorAll(`th[data-table="${table}"]`).forEach(th => {
      th.classList.remove('sorted-asc', 'sorted-desc');
      if (th.dataset.sort === field) {
        th.classList.add(dir === 'asc' ? 'sorted-asc' : 'sorted-desc');
      }
    });
  }

  /* -------- SORT CLICK HANDLERS -------- */
  document.addEventListener("DOMContentLoaded", () => {
    document.querySelectorAll("th[data-sort]").forEach(th => {
      th.addEventListener("click", () => {
        const field = th.dataset.sort;
        const table = th.dataset.table;

        if (currentSort[table].field === field) {
          currentSort[table].dir = currentSort[table].dir === 'asc' ? 'desc' : 'asc';
        } else {
          currentSort[table].field = field;
          currentSort[table].dir = field === 'name' ? 'asc' : 'desc';
        }

        if (table === 'league') {
          renderTable();
        } else if (table === 'scorers') {
          renderScorers();
        }
      });
    });
  });

  /* -------- FORMA -------- */
  function renderForm(matches) {
    const last5 = matches.slice(0,5);

    let cr = "", pl = "";

    last5.forEach(m=>{
      cr += (m.red > m.blue) ? `<span class="dot win"></span>` :
            (m.red < m.blue) ? `<span class="dot loss"></span>` :
                               `<span class="dot draw"></span>`;

      pl += (m.blue > m.red) ? `<span class="dot win"></span>` :
            (m.blue < m.red) ? `<span class="dot loss"></span>` :
                               `<span class="dot draw"></span>`;
    });

    document.getElementById("formBox").innerHTML = `
      <div>Crveni ${cr}</div>
      <div style="margin-top:10px;">Plavi ${pl}</div>
    `;
  }

  /* -------- MODAL -------- */
  window.openInfo = info => {
    document.getElementById("modalContent").innerText = info;
    document.getElementById("modalOverlay").style.display = "flex";
  };

  document.getElementById("closeModal").onclick = () =>
    document.getElementById("modalOverlay").style.display = "none";

  document.getElementById("modalOverlay").onclick = e => {
    if (e.target.id === "modalOverlay")
      document.getElementById("modalOverlay").style.display = "none";
  };
  </script>

  </body>
  </html>
