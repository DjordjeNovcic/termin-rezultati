<!DOCTYPE html>
    <html lang="sr">
    <head>
      <meta charset="UTF-8">
      <meta name="viewport" content="width=device-width, initial-scale=1.0">
      <title>Rezultati</title>
      <script type="module" src="firebase.mjs"></script>

      <style>
        * {
          box-sizing: border-box;
        }

        body {
          font-family: Arial, sans-serif;
          max-width: 900px;
          margin: 20px auto;
          padding: 0 15px;
          text-align: center;
        }

        h1 { margin-bottom: 25px; }
        h2 { margin-top: 40px; }

        #loginHolder {
          width: 100%;
          display: flex;
          justify-content: center;
          margin-bottom: 20px;
        }

        #loginBtn {
          padding: 10px 20px;
          background: #0044cc;
          color: white;
          border-radius: 6px;
          cursor: pointer;
          border: none;
          font-size: 15px;
        }

        /* KARTICA MEƒåA */
        .match-box {
          padding: 25px;
          border-radius: 12px;
          background: #fff6f6;
          border: 1px solid #e5dcdc;
          margin-bottom: 25px;
        }

        .team-logo {
          width: 90px;
          height: 90px;
          object-fit: contain;
        }

        .team-name {
          font-weight: bold;
          margin-top: 5px;
          font-size: 16px;
        }

        .score {
          font-size: 38px;
          font-weight: bold;
          margin: 10px 0;
        }

        .score-small {
          font-size: 26px;
          font-weight: bold;
          margin: 5px 0;
        }

        .info-link {
          color: #0044cc;
          cursor: pointer;
          font-size: 15px;
          text-decoration: underline;
          margin-top: 5px;
          display: inline-block;
          margin-right: 12px;
        }

        /* TABELA */
        .table-wrapper {
          overflow-x: auto;
          -webkit-overflow-scrolling: touch;
          margin: 25px -15px;
          padding: 0 15px;
        }

        table {
          width: 100%;
          border-collapse: collapse;
          min-width: 600px;
        }

        th {
          background: #ececec;
          padding: 10px 8px;
          border-bottom: 2px solid #bbb;
          cursor: pointer;
          user-select: none;
          position: relative;
          font-size: 13px;
          white-space: nowrap;
        }

        th:hover {
          background: #ddd;
        }

        th.sorted-asc::after {
          content: " ‚ñ≤";
          font-size: 10px;
          color: #0044cc;
        }

        th.sorted-desc::after {
          content: " ‚ñº";
          font-size: 10px;
          color: #0044cc;
        }

        th.no-sort {
          cursor: default;
        }

        th.no-sort:hover {
          background: #ececec;
        }

        td {
          padding: 10px 8px;
          border-bottom: 1px solid #ddd;
          font-size: 14px;
        }

        tr.highlight { background: #fff7d1; }

        /* SCORER COLORS */
        tr.team-crveni {
          background: #ffe5e5;
        }
        tr.team-plavi {
          background: #e5f0ff;
        }
        tr.team-crveni td:first-child {
          color: #b10000;
          font-weight: bold;
        }
        tr.team-plavi td:first-child {
          color: #0044cc;
          font-weight: bold;
        }

        /* Captain and Goalkeeper badges */
        .captain-badge {
          display: inline-block;
          background: linear-gradient(135deg, #ffd700, #ffed4e);
          color: #333;
          font-weight: bold;
          padding: 2px 6px;
          border-radius: 4px;
          margin-left: 6px;
          font-size: 11px;
          box-shadow: 0 2px 4px rgba(0,0,0,0.2);
          border: 1px solid #daa520;
        }

        .goalkeeper-badge {
          margin-left: 6px;
          font-size: 18px;
        }

        /* FORMA */
        .form-box { margin-top: 30px; }

        .dot {
          width: 14px;
          height: 14px;
          border-radius: 50%;
          display: inline-block;
          margin-left: 5px;
        }
        .win { background: green; }
        .loss { background: red; }
        .draw { background: orange; }

        /* Dugme */
        .more-btn {
          padding: 12px 24px;
          margin-top: 15px;
          cursor: pointer;
          border: none;
          background: #0044cc;
          color: white;
          border-radius: 6px;
          font-size: 16px;
        }

        /* MODAL */
        #modalOverlay {
          display: none;
          position: fixed;
          top: 0; left: 0;
          width: 100%; height: 100%;
          background: rgba(0,0,0,0.55);
          backdrop-filter: blur(2px);
          justify-content: center;
          align-items: center;
          z-index: 1000;
        }

        #modalBox {
          background: white;
          max-width: 600px;
          width: 90%;
          max-height: 80vh;
          overflow-y: auto;
          padding: 25px;
          border-radius: 12px;
          text-align: left;
          box-shadow: 0 0 20px rgba(0,0,0,0.25);
          margin: 20px;
        }

        #closeModal {
          float: right;
          cursor: pointer;
          font-size: 24px;
          background: #ccc;
          border-radius: 4px;
          padding: 4px 10px;
          line-height: 1;
        }

        .scorer-item {
          padding: 8px 12px;
          margin: 6px 0;
          border-radius: 6px;
          font-size: 15px;
        }

        .scorer-item.red {
          background: #ffe5e5;
          color: #b10000;
        }

        .scorer-item.blue {
          background: #e5f0ff;
          color: #0044cc;
        }

        /* MOBILE STYLES */
        @media (max-width: 768px) {
          body {
            margin: 10px auto;
            padding: 0 10px;
          }

          h1 {
            font-size: 24px;
            margin-bottom: 15px;
          }

          h2 {
            font-size: 20px;
            margin-top: 30px;
          }

          /* Match cards */
          .match-box {
            padding: 15px;
            margin-bottom: 15px;
          }

          .team-logo {
            width: 60px;
            height: 60px;
          }

          .team-name {
            font-size: 13px;
          }

          .score {
            font-size: 28px;
          }

          .score-small {
            font-size: 20px;
          }

          /* Tables */
          .table-wrapper {
            margin: 15px -10px;
            padding: 0 10px;
          }

          table {
            min-width: 500px;
          }

          th, td {
            padding: 8px 4px;
            font-size: 12px;
          }

          th {
            font-size: 11px;
          }

          /* Buttons */
          #loginBtn {
            padding: 10px 16px;
            font-size: 14px;
          }

          .more-btn {
            width: 100%;
            padding: 14px;
            font-size: 15px;
          }

          /* Form boxes */
          .form-box {
            font-size: 14px;
          }

          .dot {
            width: 12px;
            height: 12px;
            margin-left: 3px;
          }

          /* Modal */
          #modalBox {
            width: 95%;
            padding: 20px;
            margin: 10px;
          }

          #closeModal {
            font-size: 20px;
            padding: 2px 8px;
          }

          /* Info link */
          .info-link {
            font-size: 13px;
            margin-right: 8px;
            display: inline-block;
          }

          .scorer-item {
            font-size: 14px;
            padding: 6px 10px;
          }
        }

        @media (max-width: 480px) {
          h1 {
            font-size: 20px;
          }

          h2 {
            font-size: 18px;
          }

          .match-box {
            padding: 12px;
          }

          .team-logo {
            width: 50px;
            height: 50px;
          }

          .score {
            font-size: 24px;
          }

          table {
            min-width: 450px;
          }

          th, td {
            padding: 6px 3px;
            font-size: 11px;
          }

          .captain-badge {
            font-size: 9px;
            padding: 1px 4px;
          }

          .goalkeeper-badge {
            font-size: 14px;
          }

          .info-link {
            font-size: 12px;
            margin-right: 6px;
          }
        }
      </style>
    </head>
    <body>

    <div id="loginHolder">
      <button id="loginBtn" onclick="window.location='login.html'">Login</button>
    </div>

    <h1>Rezultat poslednjeg kola</h1>

    <!-- GLAVNI MEƒå -->
    <div id="mainMatch"></div>

    <!-- TABELA -->
    <h2>Tabela</h2>
    <div class="table-wrapper">
      <table>
        <thead>
          <tr>
            <th class="no-sort">Tim</th>
            <th data-sort="U" data-table="league">Utakmice</th>
            <th data-sort="P" data-table="league">Pobede</th>
            <th data-sort="N" data-table="league">Nere≈°eno</th>
            <th data-sort="I" data-table="league">Porazi</th>
            <th data-sort="GD" data-table="league">G. dati</th>
            <th data-sort="GP" data-table="league">G. primljeni</th>
            <th data-sort="GR" data-table="league">G. razlika</th>
            <th data-sort="B" data-table="league">Bodovi</th>
          </tr>
        </thead>
        <tbody id="leagueBody"></tbody>
      </table>
    </div>

    <!-- LISTA STRELACA -->
    <h2>Lista strelaca</h2>
    <div class="table-wrapper">
      <table>
        <thead>
          <tr>
            <th data-sort="name" data-table="scorers">Ime</th>
            <th data-sort="team" data-table="scorers">Tim</th>
            <th data-sort="goals" data-table="scorers">Golovi</th>
          </tr>
        </thead>
        <tbody id="scorersBody"></tbody>
      </table>
    </div>

    <!-- FORMA -->
    <div class="form-box">
      <h2>Forma poslednjih 5 meƒçeva</h2>
      <div id="formBox"></div>
    </div>

    <!-- MINI REZULTATI DOLE -->
    <div id="recentMatches"></div>

    <!-- MODAL -->
    <div id="modalOverlay">
      <div id="modalBox">
        <span id="closeModal">‚úï</span>
        <h2 id="modalTitle">Info o meƒçu</h2>
        <div id="modalContent" style="margin-top:10px;"></div>
      </div>
    </div>

    <script type="module">
    import { onValue } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-database.js";

    let allMatches = [];
    let allPlayers = { crveni: {}, plavi: {} };
    let tableData = {};
    let scorersData = [];
    let currentSort = {
      league: { field: 'B', dir: 'desc' },
      scorers: { field: 'goals', dir: 'desc' }
    };

    /* -------- FORMAT PLAYER NAME -------- */
    function formatPlayerName(name) {
      if (!name) return '';

      let displayName = name;
      let badges = '';

      const captainRegex = /\s*\(c\)\s*/i;
      if (captainRegex.test(name)) {
        displayName = name.replace(captainRegex, ' ').trim();
        badges += '<span class="captain-badge">C</span>';
      }

      const goalkeeperRegex = /\s*\(g\)\s*/i;
      if (goalkeeperRegex.test(name)) {
        displayName = name.replace(goalkeeperRegex, ' ').trim();
        badges += '<span class="goalkeeper-badge">üß§</span>';
      }

      return displayName + badges;
    }

    /* LOAD MATCHES */
    onValue(window.dbRef("matches"), snap => {
      const data = snap.val() || {};
      allMatches = Object.values(data).sort((a,b)=>b.timestamp - a.timestamp);

      renderMainAndRecent(allMatches);
      calculateTable(allMatches);
      renderTable();
      renderForm(allMatches);
    });

    /* LOAD PLAYERS FOR SCORERS */
    onValue(window.dbRef("players"), snap => {
      const players = snap.val() || {};
      allPlayers = players || { crveni: {}, plavi: {} };
      scorersData = [];

      ['crveni', 'plavi'].forEach(team => {
        if (players[team]) {
          Object.entries(players[team]).forEach(([id, player]) => {
            const goals = Number(player.goals) || 0;
            if (goals >= 1) {
              scorersData.push({
                name: player.name || '',
                team: team === 'crveni' ? 'Crveni' : 'Plavi',
                teamKey: team,
                goals: goals
              });
            }
          });
        }
      });

      renderScorers();
    });

    /* -------- MAIN MATCH + RECENT (DOLE) -------- */
    function renderMainAndRecent(matches) {
      const mainBox = document.getElementById("mainMatch");
      const recentBox = document.getElementById("recentMatches");

      mainBox.innerHTML = "";
      recentBox.innerHTML = "";

      if (!matches.length) return;

      const latest = matches[0];

      const matchLinks = `
        ${latest.info ? `<div class="info-link" onclick="openMatchInfo(0)">‚Ñπ Info o meƒçu</div>` : ""}
        <div class="info-link" onclick="openMatchScorers(0)">‚öΩ Vidi listu strelaca</div>
      `;

      mainBox.innerHTML = `
        <div class="match-box">
          <div style="opacity:0.8; margin-bottom:10px;">
            Kolo ${latest.round} ‚Äî ${latest.date} u ${latest.time}
            <div>${matchLinks}</div>
          </div>

          <div style="display:flex; justify-content:space-around; align-items:center;">
            
            <div style="text-align:center;">
              <img src="crveni.png" class="team-logo" alt="Crveni">
              <div class="team-name" style="color:#c00000;">Crveni</div>
              <a href="crveni.html" style="font-size:14px;">Vidi ekipu</a>
            </div>

            <div class="score">${latest.red} - ${latest.blue}</div>

            <div style="text-align:center;">
              <img src="plavi.png" class="team-logo" alt="Plavi">
              <div class="team-name" style="color:#0044cc;">Plavi</div>
              <a href="plavi.html" style="font-size:14px;">Vidi ekipu</a>
            </div>

          </div>
        </div>
      `;

      const recent = matches.slice(1,4);

      if (recent.length) {
        recentBox.innerHTML += `<h1 style="margin-bottom:15px; margin-top:30px;">Rezultati pro≈°lih kola</h1>`;

        recent.forEach((m, idx) => {
          const matchIndex = idx + 1;
          const recentMatchLinks = `
            ${m.info ? `<div class="info-link" onclick="openMatchInfo(${matchIndex})">‚Ñπ Info o meƒçu</div>` : ""}
            <div class="info-link" onclick="openMatchScorers(${matchIndex})">‚öΩ Vidi listu strelaca</div>
          `;

          recentBox.innerHTML += `
            <div class="match-box" style="background:#fcfcfc; border-color:#ddd; padding:18px;">
              <div style="opacity:0.7; margin-bottom:8px;">
                Kolo ${m.round} ‚Äî ${m.date} u ${m.time}
                <div>${recentMatchLinks}</div>
              </div>

              <div style="display:flex; justify-content:space-around; align-items:center;">

                <div style="text-align:center;">
                  <img src="crveni.png" class="team-logo" style="width:60px; height:60px;" alt="Crveni">
                  <div class="team-name" style="font-size:14px; color:#c00000;">Crveni</div>
                </div>

                <div class="score-small">${m.red} - ${m.blue}</div>

                <div style="text-align:center;">
                  <img src="plavi.png" class="team-logo" style="width:60px; height:60px;" alt="Plavi">
                  <div class="team-name" style="font-size:14px; color:#0044cc;">Plavi</div>
                </div>

              </div>
            </div>
          `;
        });

        recentBox.innerHTML += `
          <button class="more-btn" onclick="window.location='istorija.html'">
            Vidi sve utakmice ‚Üí
          </button>
        `;
      }
    }

    /* -------- CALCULATE TABLE DATA -------- */
    function calculateTable(matches) {
      tableData = {
        Crveni: { Tim: 'Crveni', U:0,P:0,N:0,I:0,GD:0,GP:0,GR:0,B:0 },
        Plavi:  { Tim: 'Plavi', U:0,P:0,N:0,I:0,GD:0,GP:0,GR:0,B:0 }
      };

      matches.forEach(m=>{
        tableData.Crveni.U++; tableData.Plavi.U++;

        tableData.Crveni.GD += m.red;
        tableData.Crveni.GP += m.blue;

        tableData.Plavi.GD += m.blue;
        tableData.Plavi.GP += m.red;

        if (m.red > m.blue) {
          tableData.Crveni.P++; tableData.Crveni.B += 3; tableData.Plavi.I++;
        } else if (m.blue > m.red) {
          tableData.Plavi.P++; tableData.Plavi.B += 3; tableData.Crveni.I++;
        } else {
          tableData.Crveni.N++; tableData.Plavi.N++;
          tableData.Crveni.B++; tableData.Plavi.B++;
        }
      });

      tableData.Crveni.GR = tableData.Crveni.GD - tableData.Crveni.GP;
      tableData.Plavi.GR  = tableData.Plavi.GD - tableData.Plavi.GP;
    }

    /* -------- RENDER TABLE WITH SORTING -------- */
    function renderTable() {
      const teams = Object.values(tableData);
      const { field, dir } = currentSort.league;

      teams.sort((a, b) => {
        const valA = a[field];
        const valB = b[field];

        if (valA === valB) {
          return b.B - a.B;
        }

        return dir === 'asc' ? valA - valB : valB - valA;
      });

      const tbody = document.getElementById("leagueBody");
      tbody.innerHTML = "";

      teams.forEach((team, index) => {
        const highlightClass = index === 0 ? 'class="highlight"' : '';
        tbody.innerHTML += `
          <tr ${highlightClass}>
            <td>${team.Tim}</td>
            <td>${team.U}</td>
            <td>${team.P}</td>
            <td>${team.N}</td>
            <td>${team.I}</td>
            <td>${team.GD}</td>
            <td>${team.GP}</td>
            <td>${team.GR}</td>
            <td>${team.B}</td>
          </tr>
        `;
      });

      updateSortIndicators('league');
    }

    /* -------- RENDER SCORERS TABLE -------- */
    function renderScorers() {
      const scorers = [...scorersData];
      const { field, dir } = currentSort.scorers;

      scorers.sort((a, b) => {
        if (field === 'name') {
          const nameA = a.name.replace(/\s*\(c\)\s*/gi, '').replace(/\s*\(g\)\s*/gi, '').trim().toLowerCase();
          const nameB = b.name.replace(/\s*\(c\)\s*/gi, '').replace(/\s*\(g\)\s*/gi, '').trim().toLowerCase();
          return dir === 'asc'
            ? nameA.localeCompare(nameB, 'sr')
            : nameB.localeCompare(nameA, 'sr');
        } else if (field === 'team') {
          if (a.team === b.team) {
            return b.goals - a.goals;
          }
          return dir === 'asc'
            ? a.team.localeCompare(b.team, 'sr')
            : b.team.localeCompare(a.team, 'sr');
        } else {
          if (a.goals === b.goals) {
            const nameA = a.name.replace(/\s*\(c\)\s*/gi, '').replace(/\s*\(g\)\s*/gi, '').trim();
            const nameB = b.name.replace(/\s*\(c\)\s*/gi, '').replace(/\s*\(g\)\s*/gi, '').trim();
            return nameA.localeCompare(nameB, 'sr');
          }
          return dir === 'asc' ? a.goals - b.goals : b.goals - a.goals;
        }
      });

      const tbody = document.getElementById("scorersBody");
      tbody.innerHTML = "";

      scorers.forEach(player => {
        tbody.innerHTML += `
          <tr class="team-${player.teamKey}">
            <td>${formatPlayerName(player.name)}</td>
            <td>${player.team}</td>
            <td>${player.goals}</td>
          </tr>
        `;
      });

      updateSortIndicators('scorers');
    }

    /* -------- UPDATE SORT INDICATORS -------- */
    function updateSortIndicators(table) {
      const { field, dir } = currentSort[table];

      document.querySelectorAll(`th[data-table="${table}"]`).forEach(th => {
        th.classList.remove('sorted-asc', 'sorted-desc');
        if (th.dataset.sort === field) {
          th.classList.add(dir === 'asc' ? 'sorted-asc' : 'sorted-desc');
        }
      });
    }

    /* -------- SORT CLICK HANDLERS -------- */
    document.addEventListener("DOMContentLoaded", () => {
      document.querySelectorAll("th[data-sort]").forEach(th => {
        th.addEventListener("click", () => {
          const field = th.dataset.sort;
          const table = th.dataset.table;

          if (currentSort[table].field === field) {
            currentSort[table].dir = currentSort[table].dir === 'asc' ? 'desc' : 'asc';
          } else {
            currentSort[table].field = field;
            currentSort[table].dir = field === 'name' ? 'asc' : 'desc';
          }

          if (table === 'league') {
            renderTable();
          } else if (table === 'scorers') {
            renderScorers();
          }
        });
      });
    });

    /* -------- FORMA -------- */
    function renderForm(matches) {
      const last5 = matches.slice(0,5);

      let cr = "", pl = "";

      last5.forEach(m=>{
        cr += (m.red > m.blue) ? `<span class="dot win"></span>` :
              (m.red < m.blue) ? `<span class="dot loss"></span>` :
                                 `<span class="dot draw"></span>`;

        pl += (m.blue > m.red) ? `<span class="dot win"></span>` :
              (m.blue < m.red) ? `<span class="dot loss"></span>` :
                                 `<span class="dot draw"></span>`;
      });

      document.getElementById("formBox").innerHTML = `
        <div>Crveni ${cr}</div>
        <div style="margin-top:10px;">Plavi ${pl}</div>
      `;
    }

    /* -------- MODAL - INFO -------- */
    window.openMatchInfo = idx => {
      const match = allMatches[idx];
      if (!match) return;

      document.getElementById("modalTitle").innerText = "Info o meƒçu";
      document.getElementById("modalContent").innerHTML = `<div style="white-space:pre-line;">${match.info || ''}</div>`;
      document.getElementById("modalOverlay").style.display = "flex";
    };

    /* -------- MODAL - SCORERS -------- */
    window.openMatchScorers = idx => {
      const match = allMatches[idx];
      if (!match) return;

      const scorers = match.scorers || [];

      document.getElementById("modalTitle").innerText = "Strelci na meƒçu";

      if (scorers.length === 0) {
        document.getElementById("modalContent").innerHTML = '<p>Nema strelaca za ovaj meƒç.</p>';
      } else {
        let html = '';
        scorers.forEach(scorer => {
          const playerName = allPlayers[scorer.team]?.[scorer.id]?.name || '(nepoznat)';
          const teamClass = scorer.team === 'crveni' ? 'red' : 'blue';
          html += `<div class="scorer-item ${teamClass}">${formatPlayerName(playerName)}</div>`;
        });
        document.getElementById("modalContent").innerHTML = html;
      }

      document.getElementById("modalOverlay").style.display = "flex";
    };

    document.getElementById("closeModal").onclick = () =>
      document.getElementById("modalOverlay").style.display = "none";

    document.getElementById("modalOverlay").onclick = e => {
      if (e.target.id === "modalOverlay")
        document.getElementById("modalOverlay").style.display = "none";
    };
    </script>

    </body>
    </html>
