<!DOCTYPE html>
<html lang="sr">
<head>
  <meta charset="UTF-8">
  <title>Rezultati svih odigranih utakmica</title>

  <script type="module" src="firebase.mjs"></script>

  <style>
    body {
      font-family: Arial, sans-serif;
      max-width: 900px;
      margin: 20px auto;
      padding: 0 15px;
    }

    /* ADMIN LOGIN BUTTON */
    #adminBtn {
      position: fixed;
      top: 15px;
      right: 15px;
      padding: 8px 14px;
      background: #0044cc;
      color: white;
      border-radius: 6px;
      font-size: 14px;
      border: none;
      cursor: pointer;
      z-index: 99;
    }

    h1 {
      text-align: center;
      margin-bottom: 35px;
      font-size: 28px;
    }

    /* ---- MATCH CARDS ---- */
    .match {
      padding: 25px;
      margin-bottom: 25px;
      border-radius: 12px;
      border: 1px solid #ddd;
    }

    .winner-red { background: #fff4f4; }
    .winner-blue { background: #f4f6ff; }
    .draw { background: #f8f8f8; }

    .meta {
      font-size: 14px;
      text-align: center;
      color: #666;
      margin-bottom: 15px;
    }

    .score-wrapper {
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 35px;
      flex-wrap: wrap;
    }

    .team {
      display: flex;
      flex-direction: column;
      align-items: center;
      width: 110px;
    }

    .team img {
      width: 70px;
      height: 70px;
    }

    .team-name {
      margin-top: 6px;
      font-size: 16px;
      font-weight: bold;
      cursor: default;
      text-decoration: none;
    }

    .red { color: #c00000; }
    .blue { color: #0044cc; }

    .see-squad {
      font-size: 13px;
      color: #0044cc;
      margin-top: 4px;
      cursor: pointer;
      text-decoration: underline;
    }

    .score {
      font-size: 36px;
      font-weight: bold;
      text-align: center;
      min-width: 100px;
    }

    .score.winner-red { color: #c00000; }
    .score.winner-blue { color: #0044cc; }
    .score.draw { color: #555; }

    /* ---- TABLE WRAPPER ---- */
    .table-wrapper {
      width: 100%;
      overflow-x: auto;
      margin-top: 25px;
    }

    #league {
      width: 100%;
      border-collapse: collapse;
      table-layout: fixed;
      text-align: center;
    }

    #league th {
      background: #ececec;
      padding: 10px;
      border-bottom: 2px solid #bbb;
      white-space: nowrap;
    }

    #league td {
      padding: 10px;
      border-bottom: 1px solid #ddd;
      white-space: nowrap;
    }

    #league tr:nth-child(even) td {
      background: #fafafa;
    }

    .leader-row td {
      background: #fff4d0 !important;
      font-weight: bold;
    }

    /* ---- LAST 5 FORM ---- */
    #formSection {
      margin-top: 40px;
    }

    #formSection h2 {
      text-align: center;
      margin-bottom: 15px;
    }

    .form-row {
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 10px;
      margin: 4px 0;
    }

    .form-icons span {
      font-size: 22px;
      margin: 0 2px;
    }

    .team-label {
      min-width: 70px;
      text-align: right;
      font-weight: bold;
    }
  </style>
</head>
<body>

<button id="adminBtn">Login</button>

<h1>Rezultati svih odigranih utakmica</h1>

<div id="list"></div>

<!-- TABELA LIGE -->
<div class="table-wrapper">
  <table id="league">
    <thead>
      <tr>
        <th>Tim</th>
        <th>Utakmice</th>
        <th>Pobede</th>
        <th>Nere≈°eno</th>
        <th>Porazi</th>
        <th>G. dati</th>
        <th>G. primljeni</th>
        <th>G. razlika</th>
        <th>Bodovi</th>
      </tr>
    </thead>
    <tbody id="leagueBody"></tbody>
  </table>
</div>

<!-- FORMA POSLEDNJIH 5 -->
<div id="formSection">
  <h2>Forma poslednjih 5 meƒçeva</h2>

  <div class="form-row">
    <span class="team-label red">Crveni</span>
    <span id="formCrveni" class="form-icons"></span>
  </div>

  <div class="form-row">
    <span class="team-label blue">Plavi</span>
    <span id="formPlavi" class="form-icons"></span>
  </div>
</div>


<script type="module">
import { onValue } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-database.js";

const ref = window.dbRef("matches");

/* ----- PRIKAZ MEƒåEVA ----- */
onValue(ref, snap => {
  const data = snap.val() || {};
  const listEl = document.getElementById("list");
  listEl.innerHTML = "";

  const matches = Object.values(data).sort((a,b)=>b.timestamp - a.timestamp);

  matches.forEach(m => {
    const isRedWin = m.red > m.blue;
    const isBlueWin = m.blue > m.red;
    const isDraw = m.red === m.blue;

    const cardClass = isDraw ? "draw" : isRedWin ? "winner-red" : "winner-blue";
    const scoreClass = cardClass;

    listEl.innerHTML += `
      <div class="match ${cardClass}">
        <div class="meta">Kolo <b>${m.round}</b> ‚Äî ${m.date} u ${m.time}</div>

        <div class="score-wrapper">

          <div class="team">
            <img src="crveni.png">
            <div class="team-name red">Crveni</div>
            <div class="see-squad" onclick="window.location.href='crveni.html'">Vidi ekipu</div>
          </div>

          <div class="score ${scoreClass}">${m.red} - ${m.blue}</div>

          <div class="team">
            <img src="plavi.png">
            <div class="team-name blue">Plavi</div>
            <div class="see-squad" onclick="window.location.href='plavi.html'">Vidi ekipu</div>
          </div>

        </div>
      </div>`;
  });

  /* ----- LIGA TABELA ----- */
  function calculateTable(matches) {
    const table = {
      Crveni: { U:0, P:0, N:0, I:0, GD:0, GP:0, GR:0, B:0 },
      Plavi:  { U:0, P:0, N:0, I:0, GD:0, GP:0, GR:0, B:0 }
    };

    matches.forEach(m=>{
      let r=m.red, b=m.blue;
      table.Crveni.U++; table.Plavi.U++;
      table.Crveni.GD+=r; table.Crveni.GP+=b;
      table.Plavi.GD+=b; table.Plavi.GP+=r;

      if(r>b){ table.Crveni.P++; table.Plavi.I++; table.Crveni.B+=3; }
      else if(b>r){ table.Plavi.P++; table.Crveni.I++; table.Plavi.B+=3; }
      else { table.Crveni.N++; table.Plavi.N++; table.Crveni.B++; table.Plavi.B++; }
    });

    table.Crveni.GR = table.Crveni.GD - table.Crveni.GP;
    table.Plavi.GR  = table.Plavi.GD - table.Plavi.GP;

    return table;
  }

  function renderTable(table){
    const body=document.getElementById("leagueBody");
    body.innerHTML="";

    let leader = table.Crveni.B > table.Plavi.B ? "Crveni" : "Plavi";

    ["Crveni","Plavi"].forEach(team=>{
      const t=table[team];
      body.innerHTML += `
        <tr class="${team===leader?'leader-row':''}">
          <td><b>${team}</b></td>
          <td>${t.U}</td>
          <td>${t.P}</td>
          <td>${t.N}</td>
          <td>${t.I}</td>
          <td>${t.GD}</td>
          <td>${t.GP}</td>
          <td>${t.GR}</td>
          <td>${t.B}</td>
        </tr>`;
    });
  }

  const table = calculateTable(matches);
  renderTable(table);

  /* ----- FORMA ----- */
  function calculateForm(matches){
    const c=[],p=[];
    matches.forEach(m=>{
      if(m.red>m.blue){ c.push("W"); p.push("L"); }
      else if(m.red<m.blue){ c.push("L"); p.push("W"); }
      else { c.push("D"); p.push("D"); }
    });
    return {
      Crveni:c.slice(0,5),
      Plavi:p.slice(0,5)
    };
  }

  function renderForm(form){
    const map={W:"üü¢",D:"üü°",L:"üî¥"};
    document.getElementById("formCrveni").innerHTML =
      form.Crveni.map(x=>`<span>${map[x]}</span>`).join("");

    document.getElementById("formPlavi").innerHTML =
      form.Plavi.map(x=>`<span>${map[x]}</span>`).join("");
  }

  renderForm(calculateForm(matches));
});

/* ----- LOGIN BUTTON SWITCH ----- */
const btn=document.getElementById("adminBtn");
function refreshBtn(){
  const isAdmin=localStorage.getItem("admin")==="1";
  if(isAdmin){
    btn.innerText="Admin panel";
    btn.onclick=()=>window.location.href="admin.html";
  } else {
    btn.innerText="Login";
    btn.onclick=()=>window.location.href="login.html";
  }
}
refreshBtn();
</script>

</body>
</html>
