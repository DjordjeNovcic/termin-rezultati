<!DOCTYPE html>
<html lang="sr">
<head>
  <meta charset="UTF-8">
  <title>Migration – Player Keys</title>
  <script type="module" src="firebase.mjs"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      max-width: 600px;
      margin: 40px auto;
      padding: 20px;
      text-align: center;
    }
    button {
      padding: 14px 24px;
      font-size: 18px;
      border: none;
      background: #008000;
      color: white;
      border-radius: 8px;
      cursor: pointer;
      margin-top: 20px;
    }
    #log {
      margin-top: 30px;
      text-align: left;
      white-space: pre-line;
      background: #f2f2f2;
      padding: 15px;
      border-radius: 8px;
      font-size: 15px;
    }
  </style>
</head>
<body>

<h1>Migration Tool</h1>
<p>Ovaj alat migrira igrače tako da ključevi više ne budu imena.</p>
<p><b>Pokreni jednom.</b> Mečevi se NE diraju.</p>

<button id="migrateBtn">Pokreni migraciju</button>

<div id="log"></div>

<script type="module">
import { get, push, remove, set } 
  from "https://www.gstatic.com/firebasejs/10.8.1/firebase-database.js";

const logBox = document.getElementById("log");
const log = msg => logBox.innerText += msg + "\n";

document.getElementById("migrateBtn").onclick = async () => {
  log("Pokrećem migraciju...\n");

  const snap = await get(window.dbRef("players"));
  const players = snap.val() || {};

  const teams = ["crveni", "plavi"];
  let migratedCount = 0;

  for (const team of teams) {
    if (!players[team]) continue;

    log(`\n=== Tim: ${team.toUpperCase()} ===`);

    for (const key of Object.keys(players[team])) {

      const value = players[team][key];

      // već migriran (proper object with name & numeric stats AND key is random)
      const isGoodKey = key.startsWith("-N") || key.startsWith("-M") || key.startsWith("-O");

      if (typeof value === "object" && isGoodKey) {
        log(`✔ ${value.name} je već OK`);
        continue;
      }

      log(`→ Migriram: ${key}`);

      // pripremi objekat
      const playerObj = 
        typeof value === "string"
          ? { name: value, goals: 0, matches: 0 }
          : { 
              name: value.name || key,
              goals: value.goals || 0, 
              matches: value.matches || 0 
            };

      // novi key
      const newRef = push(window.dbRef(`players/${team}`));
      await set(newRef, playerObj);

      // obriši stari entry
      await remove(window.dbRef(`players/${team}/${key}`));

      migratedCount++;
    }
  }

  log(`\n\nMigracija završena.`);
  log(`Ukupno migrirano: ${migratedCount} igrača.`);
  log("\nMožeš da zatvoriš stranicu.");
};
</script>

</body>
</html>
