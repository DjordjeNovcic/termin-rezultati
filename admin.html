<!DOCTYPE html>
<html lang="sr">
<head>
  <meta charset="UTF-8">
  <title>Admin – Mečevi</title>
  <script type="module" src="firebase.mjs"></script>

  <style>
    body {
      font-family: Arial, sans-serif;
      max-width: 750px;
      margin: 20px auto;
      padding: 0 20px;
    }
    h1 { text-align:center; margin-bottom:25px; }

    #adminNav {
      display:flex; gap:10px; background:#f0f0f0;
      padding:12px; margin-bottom:25px; border-radius:8px;
      justify-content:center; border:1px solid #ddd;
    }
    #adminNav button {
      padding:8px 12px; border:none; border-radius:6px;
      background:#0044cc; color:white; cursor:pointer;
    }

    .row { display:flex; gap:10px; margin-bottom:12px; }
    input, textarea {
      padding:10px; border-radius:6px; border:1px solid #aaa;
      font-size:15px;
    }
    textarea { width:100%; min-height:140px; resize:vertical; }

    .player-btn {
      padding:6px 12px; margin:4px; display:inline-block;
      border-radius:6px; background:#eee; border:1px solid #bbb;
      cursor:pointer; user-select:none;
    }
    .player-btn.active { background:#008000; color:white; border-color:#006600; }

    .tag {
      display:inline-flex; align-items:center;
      background:#ddd; padding:6px 10px; border-radius:6px;
      margin:4px;
    }
    .tag button {
      margin-left:6px; padding:0 6px;
      background:#c00000; color:white; border:none; border-radius:4px;
      cursor:pointer;
    }

    .save-btn,.update-btn,.cancel-btn{
      width:100%; padding:12px; border:none; border-radius:6px;
      font-size:16px; margin-top:10px; cursor:pointer;
    }
    .save-btn{background:#008000;color:white;}
    .update-btn{background:#d48a00;color:white;display:none;}
    .cancel-btn{background:#555;color:white;display:none;}

    table{width:100%; border-collapse:collapse; margin-top:25px;}
    th{background:#ececec; padding:10px; border-bottom:2px solid #bbb;}
    td{padding:10px; border-bottom:1px solid #ddd;}

    .edit-btn, .del-btn{
      padding:6px 10px; border:none; color:white; border-radius:4px;
      cursor:pointer;
    }
    .edit-btn{background:#0044cc;}
    .del-btn{background:#c00000;}
  </style>
</head>

<body>

<!-- NAV -->
<div id="adminNav">
  <button onclick="window.location.href='admin.html'">Mečevi</button>
  <button onclick="window.location.href='admin-igraci.html'">Igrači</button>
  <button onclick="logout()">Logout</button>
</div>

<script>
  if (localStorage.getItem("admin") !== "1") window.location.href = "login.html";
  function logout(){ localStorage.removeItem("admin"); window.location.href = "index.html"; }
</script>

<h1>Upravljanje mečevima</h1>

<!-- INPUT POLJA -->
<div class="row">
  <input id="round" placeholder="Kolo">
  <input id="date" type="date">
  <input id="time" type="time">
</div>

<div class="row">
  <input id="red" type="number" placeholder="Golovi Crveni">
  <input id="blue" type="number" placeholder="Golovi Plavi">
</div>

<div class="row">
  <textarea id="info" placeholder="Info o meču..."></textarea>
</div>

<!-- IGRALI -->
<h3>Igrali</h3>
<b>CRVENI</b>
<div id="playedRed"></div>

<b style="margin-top:12px; display:block;">PLAVI</b>
<div id="playedBlue"></div>

<!-- STRELCI -->
<h3 style="margin-top:20px;">Strelci</h3>

<b>CRVENI</b>
<div id="scorersRedPlayers"></div>
<div id="scorersRedTags"></div>

<b style="margin-top:12px;">PLAVI</b>
<div id="scorersBluePlayers"></div>
<div id="scorersBlueTags"></div>

<button class="save-btn" id="saveBtn">Sačuvaj meč</button>
<button class="update-btn" id="updateBtn">Sačuvaj izmene</button>
<button class="cancel-btn" id="cancelBtn">Otkaži izmenu</button>

<!-- LISTA -->
<table>
<thead>
  <tr><th>Kolo</th><th>Rezultat</th><th>Datum</th><th>Akcije</th></tr>
</thead>
<tbody id="matchList"></tbody>
</table>

<script type="module">
import { onValue, push, update, remove, get } 
  from "https://www.gstatic.com/firebasejs/10.8.1/firebase-database.js";

const ref = window.dbRef("matches");

let editingId = null;
let scorers = [];
let players = { crveni:{}, plavi:{} };

/* ---------------------------- LOAD PLAYERS -------------------------------- */
onValue(window.dbRef("players"), snap => {
  players = snap.val() || { crveni:{}, plavi:{} };
  renderPlayers();
});

/* ------------------------- RENDER PLAYERS + SCORERS ------------------------ */
function renderPlayers(){
  const PR  = document.getElementById("playedRed");
  const PB  = document.getElementById("playedBlue");
  const SRP = document.getElementById("scorersRedPlayers");
  const SBP = document.getElementById("scorersBluePlayers");

  PR.innerHTML = PB.innerHTML = SRP.innerHTML = SBP.innerHTML = "";

  for (const [id,p] of Object.entries(players.crveni)){
    PR.innerHTML  += `<div class="player-btn" data-id="${id}">${p.name}</div>`;
    SRP.innerHTML += `<div class="player-btn" data-team="crveni" data-id="${id}">${p.name}</div>`;
  }

  for (const [id,p] of Object.entries(players.plavi)){
    PB.innerHTML  += `<div class="player-btn" data-id="${id}">${p.name}</div>`;
    SBP.innerHTML += `<div class="player-btn" data-team="plavi" data-id="${id}">${p.name}</div>`;
  }

  // toggle igrali
  document.querySelectorAll("#playedRed .player-btn,#playedBlue .player-btn")
    .forEach(btn => btn.onclick = () => btn.classList.toggle("active"));

  // add scorers
  document.querySelectorAll("#scorersRedPlayers .player-btn,#scorersBluePlayers .player-btn")
    .forEach(btn => btn.onclick = () => {
      const id = btn.dataset.id;
      const team = btn.dataset.team;
      const name = players[team][id].name;

      scorers.push({ id, team, name });
      refreshTags();
    });
}

/* -------------------------- RENDER TAGOVI STRELACA ------------------------- */
function refreshTags(){
  const RT = document.getElementById("scorersRedTags");
  const BT = document.getElementById("scorersBlueTags");

  RT.innerHTML = BT.innerHTML = "";

  scorers.forEach((s,i)=>{
    const html = `
      <div class="tag">
        ${s.name}
        <button onclick="removeGoal(${i})">x</button>
      </div>`;
    if (s.team === "crveni") RT.innerHTML += html;
    else BT.innerHTML += html;
  });
}

window.removeGoal = i => {
  scorers.splice(i,1);
  refreshTags();
};

/* -------------------------- PLAYED SELECTION ------------------------------- */
function getPlayed(){
  const played={};
  document.querySelectorAll("#playedRed .active,#playedBlue .active")
    .forEach(btn => played[btn.dataset.id] = true);
  return played;
}

/* ---------------------------- VALIDACIJA ---------------------------------- */
function validate(){
  const e=[];
  if(!round.value.trim()) e.push("Kolo?");
  if(!date.value.trim()) e.push("Datum?");
  if(!time.value.trim()) e.push("Vreme?");
  if(!red.value.trim())  e.push("Golovi Crveni?");
  if(!blue.value.trim()) e.push("Golovi Plavi?");
  if(!info.value.trim()) e.push("Info?");
  if(Object.keys(getPlayed()).length===0) e.push("Nema igrali.");
  if(scorers.length===0) e.push("Nema strelaca.");

  if(e.length){ alert("Greške:\n\n"+e.join("\n")); return false; }
  return true;
}

/* ---------------------------- STATISTIKA ---------------------------------- */
async function updateStat(team,id,field,delta){
  const p = players[team][id];
  if(!p) return;
  update(window.dbRef(`players/${team}/${id}`), {
    [field]: (p[field]||0) + delta
  });
}

async function applyStats(match,dir){
  Object.keys(match.played||{}).forEach(pid=>{
    if(players.crveni[pid]) updateStat("crveni",pid,"matches",dir);
    if(players.plavi[pid])  updateStat("plavi",pid,"matches",dir);
  });

  (match.scorers||[]).forEach(s=>{
    updateStat(s.team,s.id,"goals",dir);
  });
}

/* ----------------------------- SAVE NEW ----------------------------------- */
saveBtn.onclick = async ()=>{
  if(!validate()) return;

  const match={
    round:round.value, date:date.value, time:time.value,
    red:+red.value,   blue:+blue.value,
    info:info.value.trim(),
    played:getPlayed(),
    scorers:[...scorers],
    timestamp:Date.now()
  };

  await push(ref,match);
  await applyStats(match,+1);

  clearForm();
};

/* ----------------------------- UPDATE EXISTING ----------------------------- */
updateBtn.onclick = async ()=>{
  if(!validate()) return;

  const old = (await get(window.dbRef(`matches/${editingId}`))).val();
  await applyStats(old,-1);

  const match={
    round:round.value, date:date.value, time:time.value,
    red:+red.value, blue:+blue.value,
    info:info.value.trim(),
    played:getPlayed(),
    scorers:[...scorers]
  };

  await update(window.dbRef(`matches/${editingId}`),match);
  await applyStats(match,+1);

  clearForm();
};

/* ----------------------------- DELETE MATCH ------------------------------- */
window.deleteMatch = async id =>{
  if(!confirm("Obrisati meč?")) return;
  const m = (await get(window.dbRef(`matches/${id}`))).val();
  await applyStats(m,-1);
  remove(window.dbRef(`matches/${id}`));
};

/* ----------------------------- CLEAR FORM -------------------------------- */
function clearForm(){
  editingId = null;
  round.value = "";
  date.value  = "";
  time.value  = "";
  red.value   = "";
  blue.value  = "";
  info.value  = "";
  scorers     = [];

  // reset aktivnih dugmića
  document.querySelectorAll(".player-btn.active").forEach(b=>b.classList.remove("active"));

  refreshTags();
  renderPlayers();

  saveBtn.style.display="block";
  updateBtn.style.display="none";
  cancelBtn.style.display="none";

  autoFill();
}

cancelBtn.onclick = clearForm;

/* ----------------------------- LISTA MEČEVA ------------------------------- */
onValue(ref,snap=>{
  const tbody=document.getElementById("matchList");
  tbody.innerHTML="";

  Object.entries(snap.val()||{})
    .sort((a,b)=>b[1].timestamp - a[1].timestamp)
    .forEach(([id,m])=>{
      tbody.innerHTML += `
      <tr>
        <td>${m.round}</td>
        <td>Crveni ${m.red} - ${m.blue} Plavi</td>
        <td>${m.date} ${m.time}</td>
        <td>
          <button class="edit-btn" onclick="editMatch('${id}')">Izmeni</button>
          <button class="del-btn" onclick="deleteMatch('${id}')">Obriši</button>
        </td>
      </tr>`;
    });
});

/* ----------------------------- EDIT MATCH --------------------------------- */
window.editMatch = async id =>{
  editingId = id;

  const m = (await get(window.dbRef(`matches/${id}`))).val();

  round.value = m.round;
  date.value  = m.date;
  time.value  = m.time;
  red.value   = m.red;
  blue.value  = m.blue;
  info.value  = m.info;

  scorers = [...m.scorers];
  refreshTags();
  renderPlayers();

  document.querySelectorAll(".player-btn").forEach(b=>b.classList.remove("active"));
  Object.keys(m.played||{}).forEach(pid=>{
    const el=document.querySelector(`.player-btn[data-id="${pid}"]`);
    if(el) el.classList.add("active");
  });

  saveBtn.style.display="none";
  updateBtn.style.display="block";
  cancelBtn.style.display="block";
};

/* ---------------------- AUTO KOLO + AUTO ČETVRTAK ------------------------- */
function autoFill(){
  const d = getNextThursday();
  date.value = d.toISOString().split("T")[0];
  time.value = "18:00";
}

onValue(ref,snap=>{
  round.value = Object.values(snap.val()||{}).length + 1;
});

function getNextThursday(){
  const now=new Date();
  let diff=(4-now.getDay()+7)%7;
  if(diff===0) diff=7;
  const d=new Date();
  d.setDate(now.getDate()+diff);
  return d;
}

autoFill();

</script>
</body>
</html>
